<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üß™ Test Batalla Visual KOF</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #0a0a0a;
      color: #00ff41;
      padding: 20px;
    }
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(0, 255, 65, 0.1);
      padding: 20px;
      border: 2px solid #00ff41;
      border-radius: 10px;
    }
    .test-section {
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 5px;
    }
    .test-button {
      background: #00ff41;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .test-button:hover {
      background: #ffff00;
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-weight: bold;
    }
    .status.success { background: rgba(0, 255, 65, 0.2); border: 1px solid #00ff41; }
    .status.error { background: rgba(255, 0, 64, 0.2); border: 1px solid #ff0040; }
    .status.info { background: rgba(0, 212, 255, 0.2); border: 1px solid #00d4ff; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üß™ Test Batalla Visual KOF</h1>
    
    <div class="test-section">
      <h3>1. Verificar Datos de Batalla</h3>
      <button class="test-button" onclick="verificarDatos()">Verificar localStorage</button>
      <div id="datos-status" class="status info">Pendiente...</div>
    </div>
    
    <div class="test-section">
      <h3>2. Crear Batalla de Prueba</h3>
      <button class="test-button" onclick="crearBatallaPrueba()">Crear Batalla</button>
      <div id="batalla-status" class="status info">Pendiente...</div>
    </div>
    
    <div class="test-section">
      <h3>3. Probar API de Personajes</h3>
      <button class="test-button" onclick="probarPersonajes()">Cargar Personajes</button>
      <div id="personajes-status" class="status info">Pendiente...</div>
    </div>
    
    <div class="test-section">
      <h3>4. Probar Endpoint de Turnos</h3>
      <button class="test-button" onclick="probarTurnos()">Ejecutar Turno</button>
      <div id="turnos-status" class="status info">Pendiente...</div>
    </div>
    
    <div class="test-section">
      <h3>5. Ir a Batalla Visual</h3>
      <button class="test-button" onclick="irBatallaVisual()">Abrir Batalla Visual</button>
      <div id="visual-status" class="status info">Pendiente...</div>
    </div>
    
    <div class="test-section">
      <h3>üìä Log de Pruebas</h3>
      <div id="log" style="background: rgba(0, 0, 0, 0.8); padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; font-size: 0.9rem;"></div>
    </div>
  </div>

  <script>
    let batallaId = null;
    let token = localStorage.getItem('token');
    
    function log(mensaje, tipo = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const color = tipo === 'error' ? '#ff0040' : tipo === 'success' ? '#00ff41' : '#00d4ff';
      logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${mensaje}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function actualizarStatus(elementId, mensaje, tipo) {
      const element = document.getElementById(elementId);
      element.textContent = mensaje;
      element.className = `status ${tipo}`;
    }
    
    async function verificarDatos() {
      log('üîç Verificando datos de localStorage...');
      
      const batallaId = localStorage.getItem('batallaId');
      const personajeA = localStorage.getItem('personajeA');
      const personajeB = localStorage.getItem('personajeB');
      const token = localStorage.getItem('token');
      
      if (batallaId && personajeA && personajeB && token) {
        actualizarStatus('datos-status', '‚úÖ Datos completos encontrados', 'success');
        log('‚úÖ Datos de batalla encontrados en localStorage');
        log(`   Batalla ID: ${batallaId}`);
        log(`   Personaje A: ${personajeA}`);
        log(`   Personaje B: ${personajeB}`);
      } else {
        actualizarStatus('datos-status', '‚ùå Faltan datos de batalla', 'error');
        log('‚ùå Faltan datos de batalla en localStorage', 'error');
        log(`   Batalla ID: ${batallaId || 'NO'}`);
        log(`   Personaje A: ${personajeA || 'NO'}`);
        log(`   Personaje B: ${personajeB || 'NO'}`);
        log(`   Token: ${token ? 'S√ç' : 'NO'}`);
      }
    }
    
    async function crearBatallaPrueba() {
      log('‚öîÔ∏è Creando batalla de prueba...');
      
      try {
        // Primero obtener personajes
        const personajesResponse = await fetch("https://apipelea.onrender.com/api/personajes", {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!personajesResponse.ok) {
          throw new Error('Error al obtener personajes');
        }
        
        const personajes = await personajesResponse.json();
        
        if (personajes.length < 2) {
          throw new Error('Se necesitan al menos 2 personajes');
        }
        
        // Crear batalla
        const batallaResponse = await fetch("https://apipelea.onrender.com/api/batallas/1vs1", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({
            personajeA: personajes[0]._id,
            personajeB: personajes[1]._id
          })
        });
        
        const batallaData = await batallaResponse.json();
        
        if (!batallaResponse.ok) {
          throw new Error(batallaData.mensaje || 'Error al crear batalla');
        }
        
        // Guardar datos
        localStorage.setItem("batallaId", batallaData._id);
        localStorage.setItem("personajeA", personajes[0]._id);
        localStorage.setItem("personajeB", personajes[1]._id);
        
        batallaId = batallaData._id;
        
        actualizarStatus('batalla-status', '‚úÖ Batalla creada exitosamente', 'success');
        log('‚úÖ Batalla creada correctamente');
        log(`   ID: ${batallaData._id}`);
        log(`   Personaje A: ${personajes[0].nombre}`);
        log(`   Personaje B: ${personajes[1].nombre}`);
        
      } catch (error) {
        actualizarStatus('batalla-status', `‚ùå Error: ${error.message}`, 'error');
        log(`‚ùå Error al crear batalla: ${error.message}`, 'error');
      }
    }
    
    async function probarPersonajes() {
      log('üë• Probando API de personajes...');
      
      try {
        const response = await fetch("https://apipelea.onrender.com/api/personajes", {
          headers: { Authorization: `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error('Error al obtener personajes');
        }
        
        const personajes = await response.json();
        
        actualizarStatus('personajes-status', `‚úÖ ${personajes.length} personajes cargados`, 'success');
        log(`‚úÖ ${personajes.length} personajes cargados correctamente`);
        
        personajes.slice(0, 3).forEach(p => {
          log(`   - ${p.nombre} (HP: ${p.vida}, ATK: ${p.ataque})`);
        });
        
      } catch (error) {
        actualizarStatus('personajes-status', `‚ùå Error: ${error.message}`, 'error');
        log(`‚ùå Error al cargar personajes: ${error.message}`, 'error');
      }
    }
    
    async function probarTurnos() {
      log('üéØ Probando endpoint de turnos...');
      
      if (!batallaId) {
        actualizarStatus('turnos-status', '‚ùå No hay batalla activa', 'error');
        log('‚ùå No hay batalla activa para probar turnos', 'error');
        return;
      }
      
      try {
        const response = await fetch(`https://apipelea.onrender.com/api/batallas/${batallaId}/turno`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.mensaje || 'Error en turno');
        }
        
        actualizarStatus('turnos-status', '‚úÖ Turno ejecutado correctamente', 'success');
        log('‚úÖ Turno ejecutado correctamente');
        log(`   Mensaje: ${data.mensaje}`);
        log(`   Turno: ${data.turno}`);
        if (data.ganador) {
          log(`   üèÜ Ganador: ${data.ganador}`);
        }
        
      } catch (error) {
        actualizarStatus('turnos-status', `‚ùå Error: ${error.message}`, 'error');
        log(`‚ùå Error al ejecutar turno: ${error.message}`, 'error');
      }
    }
    
    function irBatallaVisual() {
      log('üéÆ Abriendo batalla visual...');
      
      if (!localStorage.getItem('batallaId')) {
        actualizarStatus('visual-status', '‚ùå No hay batalla para mostrar', 'error');
        log('‚ùå No hay batalla configurada', 'error');
        return;
      }
      
      actualizarStatus('visual-status', '‚úÖ Redirigiendo a batalla visual...', 'success');
      log('‚úÖ Abriendo batalla visual en nueva pesta√±a');
      
      // Abrir en nueva pesta√±a
      window.open('batallaVisual.html', '_blank');
    }
    
    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      log('üß™ Test de Batalla Visual KOF iniciado');
      verificarDatos();
    });
  </script>
</body>
</html> 